<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kam Vending</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    input[type="number"] {
      width: 80px;
    }
    #buttons {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    button {
      padding: 8px 16px;
    }
    @media (max-width: 600px) {
      table, th, td {
        font-size: 12px;
      }
      input[type="number"] {
        width: 60px;
      }
    }
  </style>
</head>
<body>

<h1>Kam Vending</h1>

<table id="inventory-table">
  <thead>
    <tr>
      <th>Item</th>
      <th>Cost</th>
      <th>Price</th>
      <th>Start Inv.</th>
      <th>Current Inv.</th>
      <th>Restock</th>
      <th>Damaged</th>
      <th>Units Sold</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<section id="buttons">
  <button onclick="updateInventory()">Update Inventory</button>
  <button onclick="generateReport()">Generate Report</button>
  <button onclick="exportInventory()">Export Inventory</button>
  <input type="file" id="import-file" onchange="importInventory()">
  <button onclick="clearAllData()">Clear All Data</button>
</section>

<script>
class Item {
  constructor(name, cost, price, startInventory) {
    this.name = name;
    this.cost = parseFloat(cost);
    this.price = parseFloat(price);
    this.startInventory = parseInt(startInventory);
    this.currentInventory = parseInt(startInventory);
    this.unitsSold = 0;
    this.damagedUnits = 0;
  }
}

class VendingMachine {
  constructor() {
    this.inventory = {};
    this.loadInventory();
    if (Object.keys(this.inventory).length === 0) {
      if (confirm('No inventory found. Would you like to import inventory data?')) {
        document.getElementById('import-file').click();
      }
    }
    this.renderInventory();
  }

  saveInventory() {
    localStorage.setItem('vendingMachineInventory', JSON.stringify(this.inventory));
  }

  loadInventory() {
    const stored = localStorage.getItem('vendingMachineInventory');
    if (stored) {
      const data = JSON.parse(stored);
      for (let name in data) {
        const itemData = data[name];
        const item = new Item(name, itemData.cost, itemData.price, itemData.startInventory);
        item.currentInventory = itemData.currentInventory;
        item.unitsSold = itemData.unitsSold;
        item.damagedUnits = itemData.damagedUnits || 0;
        this.inventory[name] = item;
      }
    }
  }

  renderInventory() {
    const tbody = document.querySelector('#inventory-table tbody');
    tbody.innerHTML = '';
    for (let name in this.inventory) {
      const item = this.inventory[name];
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.name}</td>
        <td>$${item.cost.toFixed(2)}</td>
        <td>$${item.price.toFixed(2)}</td>
        <td>${item.startInventory}</td>
        <td><input type="number" id="current-${name}" value="${item.currentInventory}" min="0"></td>
        <td><input type="number" id="restock-${name}" value="0" min="0"></td>
        <td><input type="number" id="damaged-${name}" value="${item.damagedUnits}" min="0"></td>
        <td>${item.unitsSold}</td>
      `;
      tbody.appendChild(row);
    }
  }

  updateInventory() {
    for (let name in this.inventory) {
      const item = this.inventory[name];
      const newCurrentInput = parseInt(document.getElementById(`current-${name}`).value) || 0;
      const restockAmount = parseInt(document.getElementById(`restock-${name}`).value) || 0;
      const damagedAmount = parseInt(document.getElementById(`damaged-${name}`).value) || 0;

      item.damagedUnits = damagedAmount;

      // Decrease current inventory immediately by damaged
      const adjustedCurrentInventory = newCurrentInput - damagedAmount;
      item.currentInventory = Math.max(adjustedCurrentInventory, 0);

      // Calculate sold based on startInventory minus (current + damaged)
      const countedSold = item.startInventory - (item.currentInventory + item.damagedUnits);
      item.unitsSold = countedSold > 0 ? countedSold : 0;

      // Apply restocking
      item.currentInventory += restockAmount;

      // After update, reset startInventory
      item.startInventory = item.currentInventory;
    }
    this.saveInventory();
    this.renderInventory();
  }

  generateReport() {
    let report = 'Sales Report:\n\n';
    for (let name in this.inventory) {
      const item = this.inventory[name];
      report += `${item.name}: Sold ${item.unitsSold} units, Damaged ${item.damagedUnits} units\n`;
    }
    report += `\nTotal Profit: $${this.totalProfit().toFixed(2)}`;
    alert(report);
  }

  totalProfit() {
    let profit = 0;
    for (let name in this.inventory) {
      const item = this.inventory[name];
      profit += item.unitsSold * (item.price - item.cost);
    }
    return profit;
  }

  exportInventory() {
    const dataStr = JSON.stringify(this.inventory, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'inventory.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  importInventory() {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = JSON.parse(e.target.result);
        this.inventory = {};
        for (let name in data) {
          const itemData = data[name];
          const item = new Item(name, itemData.cost, itemData.price, itemData.startInventory);
          item.currentInventory = itemData.currentInventory;
          item.unitsSold = itemData.unitsSold;
          item.damagedUnits = itemData.damagedUnits || 0;
          this.inventory[name] = item;
        }
        this.saveInventory();
        this.renderInventory();
      };
      reader.readAsText(file);
    }
  }

  clearAllData() {
    const confirmation = prompt('Type "CLEAR" to delete all saved inventory data:');
    if (confirmation === "CLEAR") {
      localStorage.removeItem('vendingMachineInventory');
      alert('All data has been cleared. Reloading the app...');
      location.reload();
    } else {
      alert('Clear canceled. No data was deleted.');
    }
  }
}

const vendingMachine = new VendingMachine();

function updateInventory() {
  vendingMachine.updateInventory();
}

function generateReport() {
  vendingMachine.generateReport();
}

function exportInventory() {
  vendingMachine.exportInventory();
}

function importInventory() {
  vendingMachine.importInventory();
}

function clearAllData() {
  vendingMachine.clearAllData();
}
</script>

</body>
</html>
